# name: Deploy to Production

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup SSH
#         uses: webfactory/ssh-agent@v0.9.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Deploy to server
#         run: |
#           ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
#             set -e

#             cd ${{ secrets.SSH_PATH }}

#             # ðŸ” Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ .env.production Ð¸ Dockerfile Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¾Ð¹ (ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÐµÑÑ‚ÑŒ)
#             [ -f .env.production ] && cp .env.production /tmp/env.production.bak || true
#             [ -f _docker/node/Dockerfile ] && mkdir -p /tmp/_docker/node && cp _docker/node/Dockerfile /tmp/_docker/node/Dockerfile || true

#             # ðŸ’¥ Ð§Ð¸ÑÑ‚Ð¸Ð¼, Ð½Ð¾ Ð½Ðµ Ñ‚Ñ€Ð¾Ð³Ð°ÐµÐ¼ .env Ð¸ docker
#             git reset --hard HEAD
#             git clean -fd -e .env.production -e _docker/ -e certbot/

#             git pull origin main

#             # ðŸ” Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼, ÐµÑÐ»Ð¸ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¸ÑÑ‡ÐµÐ·Ð»Ð¾
#             [ -f /tmp/env.production.bak ] && cp /tmp/env.production.bak .env.production || true
#             [ -f /tmp/_docker/node/Dockerfile ] && cp /tmp/_docker/node/Dockerfile _docker/node/Dockerfile || true

#             # ðŸ§± Ð¡Ð±Ð¾Ñ€ÐºÐ° Ñ„Ñ€Ð¾Ð½Ñ‚Ð°
#             docker build -f _docker/node/Dockerfile -t penaty-assets .
#             docker create --name temp-assets penaty-assets
#             docker cp temp-assets:/app/public/build ./public/
#             docker rm temp-assets

#             # ðŸš€ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
#             docker compose -f docker-compose.yml -f docker-compose.prod.yml down
#             docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
#           EOF

name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e

          cd ${{ secrets.SSH_PATH }}
          git reset --hard HEAD
          git clean -fd -e .env -e certbot/ -e storage/ -e node_modules/ -e vendor/
          git pull origin main

          # 1) Ð¡Ð±Ð¾Ñ€ÐºÐ° Ñ„Ñ€Ð¾Ð½Ñ‚Ð° Ð² Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð¼ node-Ð¾Ð±Ñ€Ð°Ð·Ðµ Ð¸ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ build
          docker build -f _docker/node/Dockerfile -t penaty-assets .
          docker create --name temp-assets penaty-assets
          docker cp temp-assets:/app/public/build ./public/
          docker rm temp-assets

          # 2) ÐŸÑ€ÐµÑ„Ð»Ð°Ð¹Ñ‚ composer Ð² Ð¾Ð´Ð½Ð¾Ñ€Ð°Ð·Ð¾Ð²Ð¾Ð¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ (ÐÐ• Ñ‚Ñ€Ð¾Ð³Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ app)
          docker compose -f docker-compose.yml -f docker-compose.prod.yml run --rm app \
            sh -lc "composer validate && composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader --dry-run"

          # 3) (ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑÑ€Ð°Ð·Ñƒ (ÑƒÑÐºÐ¾Ñ€Ð¸Ñ‚ ÑÑ‚Ð°Ñ€Ñ‚ app)
          docker compose -f docker-compose.yml -f docker-compose.prod.yml run --rm app \
            sh -lc "composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader && php artisan storage:link || true"

          # 4) Ð Ð¾Ð»Ð»Ð¸Ð¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ (ÐµÑÐ»Ð¸ Ð½Ð°Ð´Ð¾ â€” Ñ Ñ€ÐµÐ±Ð¸Ð»Ð´Ð¾Ð¼)
          docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build



          # 5) ÐŸÑ€Ð¾Ð³Ñ€ÐµÐµÐ¼ ÐºÑÑˆÐ¸ Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ ÑƒÐ¶Ðµ Ð² Ð¿Ð¾Ð´Ð½ÑÑ‚Ð¾Ð¼ app
          docker compose -f docker-compose.yml -f docker-compose.prod.yml exec -T app \
            sh -lc "php artisan migrate --force && php artisan optimize:clear && php artisan optimize"


          echo 'âœ… Deploy done.'
          EOF



